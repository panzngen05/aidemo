<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestie AI (DeepSeek Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0b0f1a;
            overflow: hidden;
        }

        .wave-animation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 40px;
        }
        .wave-bar {
            width: 4px;
            height: 10px;
            background: #10b981;
            border-radius: 4px;
            animation: wave 0.8s ease-in-out infinite;
        }
        @keyframes wave {
            0%, 100% { height: 10px; }
            50% { height: 30px; }
        }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        
        .mic-active {
            box-shadow: 0 0 40px rgba(16, 185, 129, 0.4);
            animation: pulse-ring 1s infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .deepseek-gradient {
            background: linear-gradient(135deg, #0f172a 0%, #020617 100%);
        }
    </style>
</head>
<body class="text-slate-200 min-h-screen flex flex-col items-center justify-center p-6">

    <div class="max-w-md w-full deepseek-gradient rounded-[2.5rem] shadow-2xl p-8 border border-emerald-900/30 relative">
        
        <header class="text-center mb-8">
            <h1 class="text-2xl font-extrabold tracking-tight text-white flex items-center justify-center gap-2">
                <span class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></span>
                Bestie AI <span class="text-emerald-500 italic text-sm">Pro</span>
            </h1>
            <p id="sub-status" class="text-slate-500 text-[10px] mt-1 font-medium uppercase tracking-[0.2em]">Unlimited Curhat Session</p>
        </header>

        <div id="status-container" class="flex flex-col items-center mb-8">
            <div id="visualizer" class="wave-animation hidden mb-6">
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
            </div>
            
            <button id="mic-btn" class="w-20 h-20 bg-emerald-600 rounded-full flex items-center justify-center transition-all transform active:scale-95 shadow-xl hover:bg-emerald-500">
                <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                </svg>
            </button>
            <p id="current-status" class="mt-4 text-[10px] font-black tracking-[0.3em] text-emerald-400 uppercase">Klik & Ngomong</p>
        </div>

        <div class="space-y-3">
            <div class="p-4 rounded-2xl bg-slate-900/60 border border-slate-800">
                <p id="user-transcript" class="text-slate-400 text-sm italic">Mau gibah apa...</p>
            </div>
            <div class="p-4 rounded-2xl bg-emerald-500/5 border border-emerald-500/20">
                <div id="ai-response-text" class="text-slate-100 text-sm leading-relaxed font-medium italic">"Tanya aja, gue dengerin."</div>
            </div>
        </div>
        
        <div class="mt-6 flex justify-center">
            <button id="reset-btn" class="text-[9px] text-slate-600 hover:text-red-400 transition-all font-bold uppercase tracking-widest">
                Amnesia (Reset)
            </button>
        </div>
    </div>

    <script>
        const masterKey = typeof apiKey !== 'undefined' ? apiKey : "AIzaSyCMK-p1MycelHHQdqh37UGnMFKkfUgGL3E"; 

        const micBtn = document.getElementById('mic-btn');
        const resetBtn = document.getElementById('reset-btn');
        const visualizer = document.getElementById('visualizer');
        const currentStatus = document.getElementById('current-status');
        const userTranscript = document.getElementById('user-transcript');
        const aiResponseText = document.getElementById('ai-response-text');

        let isListening = false;
        let recognition;
        let chatHistory = [];
        let audioContext;

        // Inisialisasi Audio
        async function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
            }
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }
        }

        // Speech Recognition Setup
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'id-ID';
            recognition.interimResults = false;
            recognition.continuous = false;

            recognition.onstart = () => {
                isListening = true;
                micBtn.classList.add('bg-red-500', 'mic-active');
                visualizer.classList.remove('hidden');
                currentStatus.innerText = "Lagi Dengerin...";
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userTranscript.innerText = `"${transcript}"`;
                processAI(transcript);
            };

            recognition.onend = () => {
                isListening = false;
                micBtn.classList.remove('bg-red-500', 'mic-active');
                visualizer.classList.add('hidden');
                if(currentStatus.innerText === "Lagi Dengerin...") {
                    currentStatus.innerText = "Klik & Bicara";
                }
            };
        }

        micBtn.addEventListener('click', async () => {
            await initAudio(); 
            if (isListening) recognition.stop();
            else recognition.start();
        });

        resetBtn.addEventListener('click', () => {
            chatHistory = [];
            aiResponseText.innerText = "Oke, gue lupa ingatan.";
            userTranscript.innerText = "...";
        });

        async function processAI(text) {
            currentStatus.innerText = "Mikir...";
            chatHistory.push({ role: "user", parts: [{ text: text }] });

            try {
                const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${masterKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: chatHistory,
                        systemInstruction: {
                            parts: [{ text: "Lo adalah bestie akrab Jakarta, pake bahasa gaul (lo, gue, parah, gila). Jawab SINGKAT (maks 5 kata). Jangan pake markdown." }]
                        }
                    })
                });

                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;
                
                chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                if (chatHistory.length > 10) chatHistory = chatHistory.slice(-10);

                aiResponseText.innerText = aiText;
                speakText(aiText);

            } catch (error) {
                currentStatus.innerText = "Error AI";
                aiResponseText.innerText = "Duh, otak gue nge-lag.";
            }
        }

        // TTS dengan Fallback
        async function speakText(text) {
            currentStatus.innerText = "Nyiapin Suara...";
            try {
                // Percobaan 1: Gemini TTS
                const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${masterKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                        }
                    })
                });

                const data = await response.json();
                const pcmData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                
                if (pcmData) {
                    currentStatus.innerText = "Ngomong...";
                    playAudio(pcmData, 24000);
                } else {
                    throw new Error("No PCM Data");
                }
            } catch (error) {
                console.warn("Gemini TTS Gagal, pake Browser TTS...", error);
                fallbackSpeech(text);
            }
        }

        // Fallback: Pake Web Speech API (Browser TTS)
        function fallbackSpeech(text) {
            currentStatus.innerText = "Ngomong (Native)...";
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'id-ID';
            utterance.rate = 1.1;
            utterance.onend = () => currentStatus.innerText = "Siap";
            window.speechSynthesis.speak(utterance);
        }

        function playAudio(base64Data, sampleRate) {
            try {
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);

                const wavHeader = createWavHeader(bytes.length, sampleRate);
                const wavFile = new Uint8Array(wavHeader.byteLength + bytes.byteLength);
                wavFile.set(new Uint8Array(wavHeader), 0);
                wavFile.set(bytes, wavHeader.byteLength);

                const blob = new Blob([wavFile], { type: 'audio/wav' });
                const audio = new Audio(URL.createObjectURL(blob));
                audio.onended = () => {
                    currentStatus.innerText = "Siap";
                };
                audio.play().catch(() => fallbackSpeech(aiResponseText.innerText));
            } catch (err) {
                fallbackSpeech(aiResponseText.innerText);
            }
        }

        function createWavHeader(dataLength, sampleRate) {
            const buffer = new ArrayBuffer(44);
            const view = new DataView(buffer);
            const writeString = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, dataLength, true);
            return buffer;
        }

        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                } catch (e) {}
                await new Promise(res => setTimeout(res, 1000));
            }
            throw new Error('Fetch failed');
        }
    </script>
</body>
</html>
